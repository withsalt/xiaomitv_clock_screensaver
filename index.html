<!DOCTYPE html>
<html lang="zh-cn">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Clock</title>
    <style>
      body {
        background: radial-gradient(ellipse at center, #333 0%, #111 100%);
        color: white;
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        display: flex;
        justify-content: center;
        align-items: center;
        height: 100vh;
        margin: 0;
        text-shadow: 0 0 8px rgba(255, 255, 255, 0.2);
      }

      .container {
        display: flex;
        justify-content: space-between;
        align-items: center;
        width: 800px;
        max-width: 90vw;
        min-width: 700px;
      }

      .clock-container {
        position: relative;
        width: 300px;
        height: 300px;
        border: 1px solid rgba(255, 255, 255, 0.5);
        border-radius: 50%;
        margin-right: 30px;
        flex-shrink: 0;
        aspect-ratio: 1;
      }

      .hand {
        position: absolute;
        bottom: 50%;
        left: 50%;
        background-color: white;
        transform-origin: bottom;
        transform: translateX(-50%);
        transition: transform 0.5s cubic-bezier(0.4, 0, 0.2, 1);
      }

      .hour-hand {
        width: 4px;
        height: 70px;
      }

      .minute-hand {
        width: 2px;
        height: 110px;
        background-color: grey;
      }

      .second-glow {
        position: absolute;
        top: 0;
        left: 50%;
        width: 300px;
        height: 300px;
        transform: translateX(-50%);
        pointer-events: none;
      }

      .glow-arc {
        position: absolute;
        top: 0;
        left: 50%;
        width: 300px;
        height: 300px;
        transform: translateX(-50%);
        pointer-events: none;
      }

      .glow-canvas {
        position: absolute;
        top: 0;
        left: 0;
        width: 320px;
        height: 320px;
      }

      .info-container {
        display: flex;
        flex-direction: column;
        align-items: flex-end;
        gap: 25px;
        margin-left: 30px;
        text-align: right;
      }

      .weather,
      .air-quality,
      .time {
        font-weight: 200;
        /* Lighter font for large numbers */
      }

      .weather {
        font-size: 54px;
      }

      .weather-details {
        font-size: 18px;
        color: rgba(255, 255, 255, 0.8);
        font-weight: 300;
      }

      .time-display {
        display: flex;
        align-items: flex-start;
        justify-content: flex-end;
      }

      .time {
        font-size: 80px;
        letter-spacing: -2px;
      }

      .time-colon {
        margin: 0 8px;
        position: relative;
        top: -0.1em;
      }

      .time-period {
        font-size: 28px;
        margin-right: 10px;
        font-weight: 300;
        margin-top: 20px;
      }

      .date-location {
        font-size: 20px;
        color: rgba(255, 255, 255, 0.8);
        font-weight: 300;
      }

      .air-quality {
        font-size: 54px;
      }

      .air-quality-details {
        font-size: 18px;
        color: rgba(255, 255, 255, 0.8);
        font-weight: 300;
      }

      @media (max-width: 768px) {
        .container {
          width: 90vw;
          min-width: auto;
          flex-direction: column;
          gap: 40px;
        }

        .clock-container {
          margin-right: 0;
          margin-bottom: 20px;
        }

        .info-container {
          align-items: center;
          margin-left: 0;
        }
      }
    </style>
  </head>

  <body>
    <div class="container">
      <div class="clock-container">
        <div class="hand hour-hand"></div>
        <div class="hand minute-hand"></div>
        <div class="second-glow">
          <div class="glow-arc">
            <canvas class="glow-canvas" width="320" height="320"></canvas>
          </div>
        </div>
      </div>
      <div class="info-container">
        <div class="weather-info">
          <span class="weather">--</span>
          <div class="weather-details">--</div>
        </div>
        <div class="time-info">
          <div class="time-display"><span class="time-period">--</span><span class="time">--</span></div>
          <div class="date-location">--</div>
        </div>
        <div class="air-quality-info">
          <div class="air-quality">--</div>
          <div class="air-quality-details">--</div>
        </div>
      </div>
    </div>

    <script>
      const hourHand = document.querySelector(".hour-hand");
      const minuteHand = document.querySelector(".minute-hand");
      const secondGlow = document.querySelector(".glow-arc");
      const glowCanvas = document.querySelector(".glow-canvas");
      const timeEl = document.querySelector(".time");
      const timePeriodEl = document.querySelector(".time-period");
      const dateLocationEl = document.querySelector(".date-location");
      const weatherEl = document.querySelector(".weather");
      const weatherDetailsEl = document.querySelector(".weather-details");
      const airQualityEl = document.querySelector(".air-quality");
      const airQualityDetailsEl = document.querySelector(".air-quality-details");

      let currentCity = "--";
      const weatherApiUrl = "https://api.pub.quarkbook.com/api/v1/weather";
      const weatherApiToken = "cf4267afb8284fa68c516b49688467a6";

      // 解析 URL 参数
      function getUrlParam(name) {
        const url = new URL(window.location.href);
        return url.searchParams.get(name);
      }

      // 获取时间格式（默认为 12 小时制）
      const timeFormat = getUrlParam('t') === '1' ? 24 : 12;

      // 获取天气、位置和空气质量信息
      async function getWeatherData() {
        try {
          const response = await fetch(`${weatherApiUrl}?tk=${weatherApiToken}&ip=ip`);
          const result = await response.json();

          if (result.code === 0 && result.data) {
            const data = result.data;

            // 处理位置信息
            let location = "";
            if (data.location) {
              const city = data.location.city || "";
              const name = data.location.name || "";

              if (!name || city === name) {
                location = city;
              } else {
                location = city + name;
              }
            }

            // 获取今天的日期
            const today = new Date().toISOString().split("T")[0]; // 格式: YYYY-MM-DD

            // 从预报数据中找到今天的最高和最低温度
            let highTemp = data.now.temp;
            let lowTemp = data.now.temp;

            if (data.forecasts && data.forecasts.length > 0) {
              const todayForecast = data.forecasts.find((f) => f.date === today);
              if (todayForecast) {
                highTemp = todayForecast.high;
                lowTemp = todayForecast.low;
              }
            }

            // 计算AQI等级
            const aqi = data.now.aqi || 0;
            let aqiLevel = "";
            if (aqi <= 50) {
              aqiLevel = "优";
            } else if (aqi <= 100) {
              aqiLevel = "良";
            } else if (aqi <= 150) {
              aqiLevel = "轻度污染";
            } else if (aqi <= 200) {
              aqiLevel = "中度污染";
            } else if (aqi <= 300) {
              aqiLevel = "重度污染";
            } else {
              aqiLevel = "严重污染";
            }

            return {
              location: location,
              weather: {
                temperature: highTemp,
                low: lowTemp,
                text: data.now.text,
                humidity: data.now.rh,
                icon: data.now.icon,
              },
              airQuality: {
                aqi: aqi,
                pm25: data.now.pm25 || 0,
                level: aqiLevel,
              },
            };
          } else {
            console.error("获取天气数据失败:", result.message);
            return null;
          }
        } catch (error) {
          console.error("获取天气数据失败:", error);
          return null;
        }
      }

      // 更新天气显示
      async function updateWeather() {
        const result = await getWeatherData();

        if (result) {
          // 更新城市信息
          if (result.location) {
            currentCity = result.location;
          }

          // 更新天气显示
          if (result.weather) {
            const weather = result.weather;
            // 使用新接口返回的图标
            const weatherIcon = `<img src="https://www.quarkbook.com/public/images/icon/weather/${weather.icon}@1x.png" alt="${weather.text}" style="width: 20px; height: 20px; vertical-align: super;">`;
            weatherEl.innerHTML = `${weather.temperature}° ${weatherIcon}`;
            weatherDetailsEl.textContent = `${weather.low}°~${weather.temperature}° ${weather.text} 湿度 ${weather.humidity}%`;
          }

          // 更新空气质量显示
          if (result.airQuality) {
            const airQuality = result.airQuality;
            airQualityEl.textContent = airQuality.aqi;
            airQualityDetailsEl.textContent = `空气质量 ${airQuality.level}`;
          }
        }
      }

      async function setTime() {
        const now = new Date();
        const hours = now.getHours();
        const minutes = now.getMinutes();
        const seconds = now.getSeconds();
        const milliseconds = now.getMilliseconds();

        const hoursForClock = hours % 12;
        const hourDegrees = (hoursForClock / 12) * 360 + (minutes / 60) * 30;
        hourHand.style.transform = `translateX(-50%) rotate(${hourDegrees}deg)`;

        const minuteDegrees = (minutes / 60) * 360;
        minuteHand.style.transform = `translateX(-50%) rotate(${minuteDegrees}deg)`;

        const secondDegrees = (seconds / 60) * 360 + (milliseconds / 1000) * 6 + 180;
        secondGlow.style.transform = `translateX(-50%) rotate(${secondDegrees}deg)`;

        const period = timeFormat === 24 ? "" : (hours >= 12 ? "PM" : "AM");
        const displayHour = timeFormat === 24 ? hours : (hours == 0 ? 0 : hours % 12 || 12);
        const displayMinutes = minutes.toString().padStart(2, "0");
        timeEl.innerHTML = `${displayHour}<span class="time-colon">:</span>${displayMinutes}`;
        timePeriodEl.textContent = period;

        const year = now.getFullYear();
        const month = (now.getMonth() + 1).toString().padStart(2, "0");
        const date = now.getDate().toString().padStart(2, "0");
        const day = ["周日", "周一", "周二", "周三", "周四", "周五", "周六"][now.getDay()];
        dateLocationEl.textContent = `${year}.${month}.${date} ${day} ${currentCity}`;
      }

      function drawGlow() {
        const ctx = glowCanvas.getContext("2d");
        const size = 300;
        const cx = size / 2;
        const cy = size / 2;
        const radius = size / 2;
        const start = 0;
        const end = Math.PI;
        const mid = (start + end) / 2;
        const halfSpan = (end - start) / 2;
        ctx.clearRect(0, 0, size, size);
        ctx.lineCap = "butt";
        const step = Math.PI / 360;
        const EPS = 1e-4;
        for (let a = start; a < end; a += step) {
          const x = (a - mid) / halfSpan;
          const wMax = 6.0; //最大线宽
          const wMin = 0.1; //最小线宽
          const w = wMin + (wMax - wMin) * Math.exp(-2 * x * x); //宽度衰减系数
          const alpha = 0.15 + 0.85 * Math.exp(-2.0 * x * x); //亮度衰减系数
          ctx.beginPath();
          ctx.arc(cx, cy, radius, a, Math.min(a + step + EPS, end));
          ctx.lineWidth = w;
          ctx.strokeStyle = `rgba(255,255,255,${alpha})`;
          ctx.shadowColor = `rgba(255,255,255,${alpha})`;
          ctx.shadowBlur = 4 + 10 * Math.exp(-2.2 * x * x); //阴影模糊
          ctx.stroke();
        }
      }

      // 初始化函数
      async function init() {
        // 更新天气信息（同时会更新城市信息）
        await updateWeather();

        // 绘制发光效果
        drawGlow();

        // 定时更新时间
        setInterval(setTime, 100);

        // 每5分钟更新一次天气信息
        setInterval(async () => {
          await updateWeather();
        }, 10 * 60 * 1000);
      }

      // 页面加载完成后初始化
      init();
    </script>
  </body>
</html>
