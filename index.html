<!DOCTYPE html>
<html lang="zh-cn">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Clock</title>
    <style>
      body {
        background: radial-gradient(ellipse at center, #333 0%, #111 100%);
        color: white;
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        display: flex;
        justify-content: center;
        align-items: center;
        height: 100vh;
        margin: 0;
        text-shadow: 0 0 8px rgba(255, 255, 255, 0.2);
      }

      .container {
        display: flex;
        justify-content: space-between;
        align-items: center;
        width: 800px;
        max-width: 90vw;
        min-width: 700px;
      }

      .clock-container {
        position: relative;
        width: 300px;
        height: 300px;
        border: 1px solid rgba(255, 255, 255, 0.5);
        border-radius: 50%;
        margin-right: 30px;
        flex-shrink: 0;
        aspect-ratio: 1;
      }

      .hand {
        position: absolute;
        bottom: 50%;
        left: 50%;
        background-color: white;
        transform-origin: bottom;
        transform: translateX(-50%);
        transition: transform 0.5s cubic-bezier(0.4, 0, 0.2, 1);
      }

      .hour-hand {
        width: 4px;
        height: 70px;
      }

      .minute-hand {
        width: 2px;
        height: 110px;
        background-color: grey;
      }

      .second-glow {
        position: absolute;
        top: 0;
        left: 50%;
        width: 300px;
        height: 300px;
        transform: translateX(-50%);
        pointer-events: none;
      }

      .glow-arc {
        position: absolute;
        top: 0;
        left: 50%;
        width: 300px;
        height: 300px;
        transform: translateX(-50%);
        pointer-events: none;
      }

      .glow-canvas {
        position: absolute;
        top: 0;
        left: 0;
        width: 320px;
        height: 320px;
      }

      .info-container {
        display: flex;
        flex-direction: column;
        align-items: flex-end;
        gap: 25px;
        margin-left: 30px;
        text-align: right;
      }

      .weather,
      .air-quality,
      .time {
        font-weight: 200;
        /* Lighter font for large numbers */
      }

      .weather {
        font-size: 54px;
      }

      .weather-details {
        font-size: 18px;
        color: rgba(255, 255, 255, 0.8);
        font-weight: 300;
      }

      .time-display {
        display: flex;
        align-items: flex-start;
        justify-content: flex-end;
      }

      .time {
        font-size: 80px;
        letter-spacing: -2px;
      }

      .time-colon {
        margin: 0 8px;
        position: relative;
        top: -0.1em;
      }

      .time-period {
        font-size: 28px;
        margin-right: 10px;
        font-weight: 300;
        margin-top: 20px;
      }

      .date-location {
        font-size: 20px;
        color: rgba(255, 255, 255, 0.8);
        font-weight: 300;
      }

      .air-quality {
        font-size: 54px;
      }

      .air-quality-details {
        font-size: 18px;
        color: rgba(255, 255, 255, 0.8);
        font-weight: 300;
      }

      @media (max-width: 768px) {
        .container {
          width: 90vw;
          min-width: auto;
          flex-direction: column;
          gap: 40px;
        }

        .clock-container {
          margin-right: 0;
          margin-bottom: 20px;
        }

        .info-container {
          align-items: center;
          margin-left: 0;
        }
      }
    </style>
  </head>

  <body>
    <div class="container">
      <div class="clock-container">
        <div class="hand hour-hand"></div>
        <div class="hand minute-hand"></div>
        <div class="second-glow">
          <div class="glow-arc">
            <canvas class="glow-canvas" width="320" height="320"></canvas>
          </div>
        </div>
      </div>
      <div class="info-container">
        <div class="weather-info">
          <span class="weather">--</span>
          <div class="weather-details">--</div>
        </div>
        <div class="time-info">
          <div class="time-display"><span class="time-period">--</span><span class="time">--</span></div>
          <div class="date-location">--</div>
        </div>
        <div class="air-quality-info">
          <div class="air-quality">--</div>
          <div class="air-quality-details">--</div>
        </div>
      </div>
    </div>

    <script>
      const hourHand = document.querySelector(".hour-hand");
      const minuteHand = document.querySelector(".minute-hand");
      const secondGlow = document.querySelector(".glow-arc");
      const glowCanvas = document.querySelector(".glow-canvas");
      const timeEl = document.querySelector(".time");
      const timePeriodEl = document.querySelector(".time-period");
      const dateLocationEl = document.querySelector(".date-location");
      const weatherEl = document.querySelector(".weather");
      const weatherDetailsEl = document.querySelector(".weather-details");
      const airQualityEl = document.querySelector(".air-quality");
      const airQualityDetailsEl = document.querySelector(".air-quality-details");

      let currentCity = "北京";
      const defaultCity = "北京";
      const amapApiKey = "90e155d94a175f304e8e6a0ab76442b3";
      const seniverseApiKey = "SxzzRtYy9v2Y-uYeD";
      const waqiApiKey = "a41641ff4093358074df79313a7ca8668a69c5f2";

      // 解析 URL 参数
      function getUrlParam(name) {
        const url = new URL(window.location.href);
        return url.searchParams.get(name);
      }

      // 获取时间格式（默认为 12 小时制）
      const timeFormat = getUrlParam('t') === '1' ? 24 : 12;

      // 获取基于IP的城市信息
      async function getCityByIP() {
        try {
          // 首先尝试高德地图API
          const response = await fetch(`https://restapi.amap.com/v3/ip?key=${amapApiKey}`);
          const data = await response.json();

          if (data.status === "1" && data.city && data.city.length > 0) {
            return data.city;
          }
        } catch (error) {
          console.error("高德地图API获取城市信息失败:", error);
        }

        try {
          // 如果高德地图API失败，尝试备用接口
          console.log("尝试使用备用接口获取城市信息");
          const backupResponse = await fetch("http://ipinfo.oncemi.com/?type=json");
          const backupData = await backupResponse.json();

          if (backupData.area && backupData.area.length > 0) {
            const areaParts = backupData.area.split("，");
            if (areaParts.length > 1) {
              const city = areaParts[areaParts.length - 1];
              return city;
            }
          }
        } catch (backupError) {
          console.error("备用接口获取城市信息失败:", backupError);
        }

        return null;
      }

      // 获取天气信息
      async function getWeather(city) {
        try {
          const response = await fetch(
            `https://api.seniverse.com/v3/weather/daily.json?key=${seniverseApiKey}&location=${encodeURIComponent(
              city
            )}&language=zh-Hans&unit=c&start=0&days=1`
          );
          const data = await response.json();

          if (data.results && data.results.length > 0 && data.results[0].daily && data.results[0].daily.length > 0) {
            const weather = data.results[0].daily[0];
            return {
              temperature: weather.high,
              low: weather.low,
              text: weather.text_day,
              humidity: weather.humidity,
              code: weather.code_day < 0 || weather.code_day > 38 ? 99 : weather.code_day, // 添加天气code
            };
          } else {
            return null; // 获取天气失败
          }
        } catch (error) {
          console.error("获取天气信息失败:", error);
          return null; // 获取天气失败
        }
      }

      // 获取空气质量信息
      async function getAirQuality(city) {
        try {
          const response = await fetch(`https://api.waqi.info/feed/${encodeURIComponent(city)}/?token=${waqiApiKey}`);
          const data = await response.json();
          if (data.status === "ok" && data.data) {
            const aqi = data.data.aqi;
            const pm25 = data.data.iaqi?.pm25?.v || 0;

            let level = "";
            if (aqi <= 50) {
              level = "优";
            } else if (aqi <= 100) {
              level = "良";
            } else if (aqi <= 150) {
              level = "轻度污染";
            } else if (aqi <= 200) {
              level = "中度污染";
            } else if (aqi <= 300) {
              level = "重度污染";
            } else {
              level = "严重污染";
            }
            return {
              aqi: aqi,
              pm25: pm25,
              level: level,
            };
          } else {
            return null;
          }
        } catch (error) {
          console.error("获取空气质量信息失败:", error);
          return null;
        }
      }

      // 更新天气显示
      async function updateWeather() {
        const [weather, airQuality] = await Promise.all([getWeather(currentCity), getAirQuality(currentCity)]);

        if (weather) {
          // 使用天气code对应的图标
          const weatherIcon = `<img src="https://www.quarkbook.com/public/images/icon/weather/${weather.code}@1x.png" alt="${weather.text}" style="width: 20px; height: 20px; vertical-align: super;">`;
          weatherEl.innerHTML = `${weather.temperature}° ${weatherIcon}`;
          weatherDetailsEl.textContent = `${weather.low}°~${weather.temperature}° ${weather.text} 湿度 ${weather.humidity}%`;
        }

        if (airQuality) {
          airQualityEl.textContent = airQuality.aqi;
          airQualityDetailsEl.textContent = `空气质量 ${airQuality.level}`;
        }
      }

      async function setTime() {
        const now = new Date();
        const hours = now.getHours();
        const minutes = now.getMinutes();
        const seconds = now.getSeconds();
        const milliseconds = now.getMilliseconds();

        const hoursForClock = hours % 12;
        const hourDegrees = (hoursForClock / 12) * 360 + (minutes / 60) * 30;
        hourHand.style.transform = `translateX(-50%) rotate(${hourDegrees}deg)`;

        const minuteDegrees = (minutes / 60) * 360;
        minuteHand.style.transform = `translateX(-50%) rotate(${minuteDegrees}deg)`;

        const secondDegrees = (seconds / 60) * 360 + (milliseconds / 1000) * 6 + 180;
        secondGlow.style.transform = `translateX(-50%) rotate(${secondDegrees}deg)`;

        const period = timeFormat === 24 ? "" : (hours >= 12 ? "PM" : "AM");
        const displayHour = timeFormat === 24 ? hours : (hours == 0 ? 0 : hours % 12 || 12);
        const displayMinutes = minutes.toString().padStart(2, "0");
        timeEl.innerHTML = `${displayHour}<span class="time-colon">:</span>${displayMinutes}`;
        timePeriodEl.textContent = period;

        console.log(displayHour + "," + displayMinutes + "," + seconds);

        const year = now.getFullYear();
        const month = (now.getMonth() + 1).toString().padStart(2, "0");
        const date = now.getDate().toString().padStart(2, "0");
        const day = ["周日", "周一", "周二", "周三", "周四", "周五", "周六"][now.getDay()];
        dateLocationEl.textContent = `${year}-${month}-${date} ${day} ${currentCity}`;
      }

      function drawGlow() {
        const ctx = glowCanvas.getContext("2d");
        const size = 300;
        const cx = size / 2;
        const cy = size / 2;
        const radius = size / 2;
        const start = 0;
        const end = Math.PI;
        const mid = (start + end) / 2;
        const halfSpan = (end - start) / 2;
        ctx.clearRect(0, 0, size, size);
        ctx.lineCap = "butt";
        const step = Math.PI / 360;
        const EPS = 1e-4;
        for (let a = start; a < end; a += step) {
          const x = (a - mid) / halfSpan;
          const wMax = 6.0; //最大线宽
          const wMin = 0.1; //最小线宽
          const w = wMin + (wMax - wMin) * Math.exp(-2 * x * x); //宽度衰减系数
          const alpha = 0.15 + 0.85 * Math.exp(-2.0 * x * x); //亮度衰减系数
          ctx.beginPath();
          ctx.arc(cx, cy, radius, a, Math.min(a + step + EPS, end));
          ctx.lineWidth = w;
          ctx.strokeStyle = `rgba(255,255,255,${alpha})`;
          ctx.shadowColor = `rgba(255,255,255,${alpha})`;
          ctx.shadowBlur = 4 + 10 * Math.exp(-2.2 * x * x); //阴影模糊
          ctx.stroke();
        }
      }

      // 初始化函数
      async function init() {
        // 获取城市信息
        const city = await getCityByIP();
        currentCity = city ?? defaultCity;

        // 更新天气信息
        await updateWeather();

        // 绘制发光效果
        drawGlow();

        // 定时更新时间
        setInterval(setTime, 100);

        // 每5分钟更新一次天气信息
        setInterval(async () => {
          await updateWeather();
        }, 5 * 60 * 1000);
      }

      // 页面加载完成后初始化
      init();
    </script>
  </body>
</html>
